<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Block Coding Platform</title>
  <style>
    /* Basic Styling */
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #appTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      cursor: pointer;
      user-select: none;
    }
    #blocklyDiv {
      height: 100%;
      width: 70%;
      border-right: 2px solid #ccc;
    }
    #controls {
      width: 30%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      background-color: #f9f9f9;
    }
    button {
      padding: 10px 20px;
      margin: 5px 0;
      font-size: 16px;
      width: 100%;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      height: 150px;
      margin-top: 10px;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background-color: #fff;
      resize: vertical;
    }
    #output {
      width: 100%;
      height: 150px;
      margin-top: 10px;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background-color: #eef;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    /* Modal Styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 100; 
      padding-top: 100px; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 300px;
      text-align: center;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
    }
    /* Project List Styles */
    .project-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .project-item:hover {
      background-color: #eaeaea;
    }
    .share-button, .delete-button, .remix-button {
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 5px;
    }
    /* Teacher Account Creation Section */
    #teacherControls {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }
    #teacherControls h3 {
      margin-bottom: 10px;
    }
    .account-item {
      padding: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    /* Radio Buttons Styling */
    .role-selection {
      text-align: left;
      margin: 10px 0;
    }
    .role-selection label {
      margin-right: 10px;
    }
    /* Green Flag Button Styling */
    #greenFlagBtn {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
    }
  </style>
  <!-- Include Blockly -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body>

  <!-- Application Title -->
  <h1 id="appTitle">Block Coding Platform</h1>

  <!-- Blockly Workspace -->
  <div id="blocklyDiv"></div>

  <!-- Controls and Output -->
  <div id="controls">
    <!-- Authentication Section -->
    <div id="authSection">
      <h2>Welcome</h2>
      <button id="loginBtn">Login</button>
      <button id="registerBtn">Register</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
      <p id="currentUser"></p>
    </div>

    <!-- Project Controls -->
    <div id="projectControls" style="display:none;">
      <button id="greenFlagBtn">Green Flag</button>
      <button id="saveButton">Save Project</button>
      <button id="exportCodeButton">Export Code</button>
      <button id="exportProjectButton">Export Project</button>
      <button id="importProjectButton">Import Project</button>
      <button id="viewSharedProjectsButton">View Shared Projects</button>
      
      <h3>Generated JavaScript Code:</h3>
      <textarea id="codeArea" readonly></textarea>
      
      <h3>Output:</h3>
      <div id="output"></div>
      
      <h3>My Projects:</h3>
      <div id="myProjectList"></div>
      
      <h3>Shared Projects:</h3>
      <div id="sharedProjectList"></div>
    </div>

    <!-- Teacher Account Creation Section -->
    <div id="teacherControls" style="display:none;">
      <h3>Create Student Account</h3>
      <button id="createStudentBtn">Create Student Account</button>
      <div id="studentAccountsList"></div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="authTitle">Login</h2>
      <form id="authForm">
        <input type="email" id="email" placeholder="Email" required><br><br>
        <input type="password" id="password" placeholder="Password" required><br><br>
        <div class="role-selection" id="roleSelection" style="display:none;">
          <label><input type="radio" name="role" value="student" checked> Student</label>
          <label><input type="radio" name="role" value="teacher"> Teacher</label>
        </div>
        <button type="submit" id="authButton">Login</button>
      </form>
      <p id="toggleAuth">Don't have an account? <a href="#" id="toggleLink">Register here</a></p>
    </div>
  </div>

  <!-- Hidden File Input for Importing Projects -->
  <input type="file" id="importFile" accept=".xml">

  <script>
    // ===========================
    // Blockly Initialization
    // ===========================
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: `<xml xmlns="https://developers.google.com/blockly/xml">
                  <category name="Events" colour="120">
                    <block type="event_when_green_flag_clicked"></block>
                    <block type="event_when_title_clicked"></block>
                  </category>
                  <category name="Control" colour="%{BKY_LOGIC_HUE}">
                    <block type="controls_if"></block>
                    <block type="controls_ifelse"></block>
                    <block type="controls_repeat_ext">
                      <value name="TIMES">
                        <shadow type="math_number">
                          <field name="NUM">10</field>
                        </shadow>
                      </value>
                    </block>
                    <block type="controls_whileUntil"></block>
                    <block type="controls_for">
                      <value name="FROM">
                        <shadow type="math_number">
                          <field name="NUM">1</field>
                        </shadow>
                      </value>
                      <value name="TO">
                        <shadow type="math_number">
                          <field name="NUM">10</field>
                        </shadow>
                      </value>
                      <value name="BY">
                        <shadow type="math_number">
                          <field name="NUM">1</field>
                        </shadow>
                      </value>
                    </block>
                    <block type="controls_forEach"></block>
                    <block type="controls_flow_statements"></block>
                  </category>
                  <category name="Math" colour="%{BKY_MATH_HUE}">
                    <block type="math_number">
                      <field name="NUM">123</field>
                    </block>
                    <block type="math_arithmetic"></block>
                    <block type="math_single"></block>
                    <block type="math_trig"></block>
                    <block type="math_constant"></block>
                    <block type="math_number_property"></block>
                    <block type="math_round"></block>
                    <block type="math_on_list"></block>
                    <block type="math_modulo"></block>
                    <block type="math_constrain"></block>
                    <block type="math_random_int"></block>
                    <block type="math_random_float"></block>
                    <block type="math_atan2"></block>
                  </category>
                  <category name="Text" colour="%{BKY_TEXTS_HUE}">
                    <block type="text"></block>
                    <block type="text_join"></block>
                    <block type="text_append">
                      <value name="TEXT">
                        <shadow type="text"></shadow>
                      </value>
                    </block>
                    <block type="text_length"></block>
                    <block type="text_isEmpty"></block>
                    <block type="text_indexOf">
                      <value name="FIND">
                        <shadow type="text"></shadow>
                      </value>
                    </block>
                    <block type="text_charAt">
                      <value name="WHERE">
                        <shadow type="text_indexOf">
                          <field name="END">FIRST</field>
                        </shadow>
                      </value>
                    </block>
                    <block type="text_getSubstring">
                      <value name="WHERE1">
                        <shadow type="text_indexOf">
                          <field name="END">FIRST</field>
                        </shadow>
                      </value>
                      <value name="WHERE2">
                        <shadow type="text_indexOf">
                          <field name="END">LAST</field>
                        </shadow>
                      </value>
                    </block>
                    <block type="text_changeCase"></block>
                    <block type="text_trim"></block>
                    <block type="text_print"></block>
                    <block type="text_prompt_ext">
                      <value name="TEXT">
                        <shadow type="text"></shadow>
                      </value>
                    </block>
                  </category>
                  <category name="Variables" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
                  <category name="Functions" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
                  <category name="Custom" colour="210">
                    <block type="display_image"></block>
                  </category>
                </xml>`
    });

    // ===========================
    // Custom Blocks Definition
    // ===========================
    // Define a custom block for displaying images
    Blockly.Blocks['display_image'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Display Image")
            .appendField(new Blockly.FieldTextInput("https://"), "IMAGE_URL");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(160);
        this.setTooltip("Displays an image from a specified URL.");
        this.setHelpUrl("");
      }
    };

    Blockly.JavaScript['display_image'] = function(block) {
      var image_url = block.getFieldValue('IMAGE_URL');
      var code = `displayImage("${image_url}");\n`;
      return code;
    };

    // Define a custom event block for "when green flag clicked"
    Blockly.Blocks['event_when_green_flag_clicked'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("when green flag clicked");
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("Start program when green flag is clicked.");
        this.setHelpUrl("");
      }
    };

    Blockly.JavaScript['event_when_green_flag_clicked'] = function(block) {
      var branch = Blockly.JavaScript.statementToCode(block, 'DO');
      var code = `document.getElementById('greenFlagBtn').addEventListener('click', function() {\n${branch}});\n`;
      return code;
    };

    // Define a custom event block for "when title clicked"
    Blockly.Blocks['event_when_title_clicked'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("when title clicked");
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("Start program when title is clicked.");
        this.setHelpUrl("");
      }
    };

    Blockly.JavaScript['event_when_title_clicked'] = function(block) {
      var branch = Blockly.JavaScript.statementToCode(block, 'DO');
      var code = `document.getElementById('appTitle').addEventListener('click', function() {\n${branch}});\n`;
      return code;
    };

    // ===========================
    // Custom Block Functionality
    // ===========================
    function displayImage(url) {
      var img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      document.getElementById('output').appendChild(img);
    }

    // ===========================
    // User Authentication Logic
    // ===========================
    const authModal = document.getElementById('authModal');
    const authTitle = document.getElementById('authTitle');
    const authForm = document.getElementById('authForm');
    const authButton = document.getElementById('authButton');
    const toggleAuth = document.getElementById('toggleAuth');
    const toggleLink = document.getElementById('toggleLink');
    const closeModal = document.getElementsByClassName('close')[0];

    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserP = document.getElementById('currentUser');
    const projectControls = document.getElementById('projectControls');
    const teacherControls = document.getElementById('teacherControls');
    const studentAccountsList = document.getElementById('studentAccountsList');

    let isLogin = true;
    let currentUser = null;
    let currentUserRole = 'student'; // Default role

    // Open Login Modal
    loginBtn.onclick = function() {
      isLogin = true;
      authTitle.innerText = "Login";
      authButton.innerText = "Login";
      toggleAuth.innerHTML = `Don't have an account? <a href="#" id="toggleLink">Register here</a>`;
      document.getElementById('roleSelection').style.display = "none";
      authModal.style.display = "block";
    }

    // Open Register Modal
    registerBtn.onclick = function() {
      isLogin = false;
      authTitle.innerText = "Register";
      authButton.innerText = "Register";
      toggleAuth.innerHTML = `Already have an account? <a href="#" id="toggleLink">Login here</a>`;
      document.getElementById('roleSelection').style.display = "block";
      authModal.style.display = "block";
    }

    // Close Modal
    closeModal.onclick = function() {
      authModal.style.display = "none";
    }

    // Toggle between Login and Register
    toggleLink.onclick = function(e) {
      e.preventDefault();
      isLogin = !isLogin;
      authTitle.innerText = isLogin ? "Login" : "Register";
      authButton.innerText = isLogin ? "Login" : "Register";
      toggleAuth.innerHTML = isLogin ? `Don't have an account? <a href="#" id="toggleLink">Register here</a>` :
                                      `Already have an account? <a href="#" id="toggleLink">Login here</a>`;
      document.getElementById('roleSelection').style.display = isLogin ? "none" : "block";
    }

    // Handle Authentication Form Submission
    authForm.onsubmit = function(e) {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const roleElements = document.getElementsByName('role');
      let selectedRole = 'student'; // Default role

      for (let i = 0; i < roleElements.length; i++) {
        if (roleElements[i].checked) {
          selectedRole = roleElements[i].value;
          break;
        }
      }

      if (isLogin) {
        // Login
        loginUser(email, password);
      } else {
        // Register
        registerUser(email, password, selectedRole);
      }
    }

    // Function to Register User
    function registerUser(email, password, role) {
      if (localStorage.getItem(`user_${email}`)) {
        alert("User already exists. Please login.");
        return;
      }

      // Save user to localStorage
      const userData = { email: email, password: password, role: role };
      localStorage.setItem(`user_${email}`, JSON.stringify(userData));

      alert(`Registration successful! You are registered as a ${capitalizeFirstLetter(role)}.`);
      authModal.style.display = "none";
    }

    // Function to Login User
    function loginUser(email, password) {
      const userData = JSON.parse(localStorage.getItem(`user_${email}`));
      if (!userData) {
        alert("User does not exist. Please register.");
        return;
      }
      if (userData.password !== password) {
        alert("Incorrect password.");
        return;
      }
      currentUser = email;
      currentUserRole = userData.role;
      updateUIOnLogin();
      authModal.style.display = "none";
    }

    // Function to Update UI After Login
    function updateUIOnLogin() {
      currentUserP.innerText = `Logged in as: ${currentUser} (${capitalizeFirstLetter(currentUserRole)})`;
      loginBtn.style.display = "none";
      registerBtn.style.display = "none";
      logoutBtn.style.display = "block";
      projectControls.style.display = "block";
      if (currentUserRole === 'teacher') {
        teacherControls.style.display = "block";
        loadStudentAccounts();
      } else {
        teacherControls.style.display = "none";
      }
      loadUserProjects();
      if (currentUserRole === 'teacher') {
        loadSharedProjects();
      }
      localStorage.setItem('currentUser', currentUser);
      initializeEventListeners(); // Reinitialize event listeners based on loaded code
    }

    // Logout Functionality
    logoutBtn.onclick = function() {
      currentUser = null;
      currentUserRole = 'student';
      currentUserP.innerText = "";
      loginBtn.style.display = "block";
      registerBtn.style.display = "block";
      logoutBtn.style.display = "none";
      projectControls.style.display = "none";
      teacherControls.style.display = "none";
      document.getElementById('myProjectList').innerHTML = "";
      document.getElementById('sharedProjectList').innerHTML = "";
      document.getElementById('output').innerHTML = "";
      document.getElementById('codeArea').value = "";
      workspace.clear();
      studentAccountsList.innerHTML = "";
      localStorage.removeItem('currentUser');
    }

    // Utility Function to Capitalize First Letter
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // ===========================
    // Project Management Logic
    // ===========================
    const greenFlagBtn = document.getElementById('greenFlagBtn');
    const runButton = document.getElementById('runButton');
    const saveButton = document.getElementById('saveButton');
    const exportCodeButton = document.getElementById('exportCodeButton');
    const exportProjectButton = document.getElementById('exportProjectButton');
    const importProjectButton = document.getElementById('importProjectButton');
    const viewSharedProjectsButton = document.getElementById('viewSharedProjectsButton');
    const myProjectList = document.getElementById('myProjectList');
    const sharedProjectList = document.getElementById('sharedProjectList');
    const importFileInput = document.getElementById('importFile');

    // Function to Initialize Event Listeners
    function initializeEventListeners() {
      // Clear previous listeners to prevent multiple bindings
      greenFlagBtn.replaceWith(greenFlagBtn.cloneNode(true));
      const newGreenFlagBtn = document.getElementById('greenFlagBtn');
      newGreenFlagBtn.addEventListener('click', function() {
        runButton.click();
      });

      // Ensure that the title click event is bound
      // Remove existing listeners
      const appTitle = document.getElementById('appTitle');
      const newAppTitle = appTitle.cloneNode(true);
      appTitle.parentNode.replaceChild(newAppTitle, appTitle);

      // Add event listener
      newAppTitle.addEventListener('click', function() {
        // Execute blocks connected to "when title clicked"
        // The event block should already have set up the listener
        // So nothing needed here
      });
    }

    // Run Code (Triggers the execution)
    runButton.onclick = function() {
      // Clear previous output
      document.getElementById('output').innerHTML = '';
      // Override console.log
      console.log = function(message) {
        var msg = typeof message === 'object' ? JSON.stringify(message) : message;
        document.getElementById('output').innerHTML += msg + '<br>';
      };
      try {
        // Generate JavaScript code from blocks
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        document.getElementById('codeArea').value = code;
        // Execute the generated code
        eval(code);
      } catch (e) {
        document.getElementById('output').innerHTML += `<span style="color: red;">Error: ${e.message}</span>`;
      }
    }

    // Save Project
    saveButton.onclick = function() {
      if (!currentUser) {
        alert("Please login to save projects.");
        return;
      }
      const projectName = prompt("Enter project name:");
      if (!projectName) return;

      const xml = Blockly.Xml.workspaceToDom(workspace);
      const xmlText = Blockly.Xml.domToText(xml);

      // Retrieve existing projects
      let projects = JSON.parse(localStorage.getItem(`projects_${currentUser}`)) || {};

      // Save project
      projects[projectName] = { xml: xmlText, shared: false };
      localStorage.setItem(`projects_${currentUser}`, JSON.stringify(projects));

      alert("Project saved successfully!");
      loadUserProjects();
    }

    // Export Code
    exportCodeButton.onclick = function() {
      if (!currentUser) {
        alert("Please login to export code.");
        return;
      }
      const code = document.getElementById('codeArea').value;
      if (!code) {
        alert("No code to export. Please run your code first.");
        return;
      }

      const blob = new Blob([code], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'code.js';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Export Project
    exportProjectButton.onclick = function() {
      if (!currentUser) {
        alert("Please login to export projects.");
        return;
      }
      const projectName = prompt("Enter project name to export:");
      if (!projectName) return;

      let projects = JSON.parse(localStorage.getItem(`projects_${currentUser}`)) || {};
      if (!projects[projectName]) {
        alert("Project not found.");
        return;
      }

      const projectData = {
        name: projectName,
        xml: projects[projectName].xml,
        shared: projects[projectName].shared
      };

      const blob = new Blob([projectData.xml], { type: 'text/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${projectName}.xml`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Import Project
    importProjectButton.onclick = function() {
      importFileInput.click();
    }

    importFileInput.onchange = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const xmlText = e.target.result;
          const xml = Blockly.Xml.textToDom(xmlText);
          Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
          alert("Project imported successfully!");
        } catch (error) {
          alert("Error reading project file. Please ensure it's a valid XML file.");
        }
      }
      reader.readAsText(file);
      // Reset the input
      importFileInput.value = "";
    }

    // Share Project
    document.getElementById('share').addEventListener('click', function() {
      // This button is removed in the latest implementation. Sharing is done via the "Share Project" button.
      // Kept here for compatibility if needed.
    });

    // View Shared Projects
    viewSharedProjectsButton.onclick = function() {
      loadSharedProjects();
    }

    // Function to Load User's Projects
    function loadUserProjects() {
      if (!currentUser) return;
      let projects = JSON.parse(localStorage.getItem(`projects_${currentUser}`)) || {};
      myProjectList.innerHTML = "";

      if (Object.keys(projects).length === 0) {
        myProjectList.innerHTML = "<p>No projects found.</p>";
        return;
      }

      for (let projectName in projects) {
        let project = projects[projectName];
        let div = document.createElement('div');
        div.className = 'project-item';
        div.innerHTML = `<span>${projectName}</span>`;

        // Add Share Button for Teachers
        if (currentUserRole === 'teacher') {
          let shareBtn = document.createElement('button');
          shareBtn.className = 'share-button';
          shareBtn.innerText = project.shared ? "Unshare" : "Share";
          shareBtn.onclick = function(e) {
            e.stopPropagation();
            project.shared = !project.shared;
            projects[projectName].shared = project.shared;
            localStorage.setItem(`projects_${currentUser}`, JSON.stringify(projects));
            alert(`Project ${project.shared ? "shared" : "unshared"} successfully!`);
            loadUserProjects();
            if (project.shared) {
              loadSharedProjects();
            } else {
              removeProjectFromSharedList(projectName, currentUser);
            }
          }
          div.appendChild(shareBtn);
        }

        // Add Delete Button
        let deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-button';
        deleteBtn.innerText = "Delete";
        deleteBtn.onclick = function(e) {
          e.stopPropagation();
          if (confirm(`Are you sure you want to delete the project "${projectName}"?`)) {
            delete projects[projectName];
            localStorage.setItem(`projects_${currentUser}`, JSON.stringify(projects));
            alert("Project deleted.");
            loadUserProjects();
          }
        }
        div.appendChild(deleteBtn);

        div.onclick = function() {
          loadProject(project.xml);
        }

        myProjectList.appendChild(div);
      }
    }

    // Function to Load Shared Projects (Teachers Only)
    function loadSharedProjects() {
      if (!currentUser || currentUserRole !== 'teacher') return;
      sharedProjectList.innerHTML = "";

      let allProjects = {};

      for (let key in localStorage) {
        if (key.startsWith('user_')) {
          let user = JSON.parse(localStorage.getItem(key));
          if (user.role === 'student') {
            let projects = JSON.parse(localStorage.getItem(`projects_${user.email}`)) || {};
            for (let projectName in projects) {
              let project = projects[projectName];
              if (project.shared) {
                allProjects[`${projectName} (by ${user.email})`] = project.xml;
              }
            }
          }
        }
      }

      if (Object.keys(allProjects).length === 0) {
        sharedProjectList.innerHTML = "<p>No shared projects available.</p>";
        return;
      }

      for (let projectName in allProjects) {
        let xml = allProjects[projectName];
        let div = document.createElement('div');
        div.className = 'project-item';
        div.innerHTML = `<span>${projectName}</span>`;

        // Add Remix Button
        let remixBtn = document.createElement('button');
        remixBtn.className = 'remix-button';
        remixBtn.innerText = "Remix";
        remixBtn.onclick = function(e) {
          e.stopPropagation();
          if (confirm(`Do you want to remix the project "${projectName}"?`)) {
            loadProject(xml);
            alert("Project loaded for remixing. Don't forget to save it with a new name!");
          }
        }
        div.appendChild(remixBtn);

        div.onclick = function() {
          loadProject(xml);
        }

        sharedProjectList.appendChild(div);
      }
    }

    // Function to Remove Unshared Project from Shared List
    function removeProjectFromSharedList(projectName, userEmail) {
      if (currentUserRole !== 'teacher') return;
      // Reload shared projects
      loadSharedProjects();
    }

    // Function to Load Project into Workspace
    function loadProject(xmlText) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "text/xml");
      Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
      alert("Project loaded!");
      initializeEventListeners(); // Reinitialize event listeners after loading
    }

    // ===========================
    // Teacher Account Creation Logic
    // ===========================
    const createStudentBtn = document.getElementById('createStudentBtn');

    createStudentBtn.onclick = function() {
      if (currentUserRole !== 'teacher') {
        alert("Only teachers can create student accounts.");
        return;
      }
      const studentEmail = prompt("Enter student email (dummy email):");
      const studentPassword = prompt("Enter student password:");

      if (!studentEmail || !studentPassword) {
        alert("Email and password cannot be empty.");
        return;
      }

      if (localStorage.getItem(`user_${studentEmail}`)) {
        alert("A user with this email already exists.");
        return;
      }

      // Create student account with dummy email
      const userData = { email: studentEmail, password: studentPassword, role: 'student' };
      localStorage.setItem(`user_${studentEmail}`, JSON.stringify(userData));

      alert(`Student account created for ${studentEmail}.`);
      loadStudentAccounts();
    }

    function loadStudentAccounts() {
      studentAccountsList.innerHTML = "";
      let studentUsers = [];

      for (let key in localStorage) {
        if (key.startsWith('user_')) {
          let user = JSON.parse(localStorage.getItem(key));
          if (user.role === 'student') {
            studentUsers.push(user.email);
          }
        }
      }

      if (studentUsers.length === 0) {
        studentAccountsList.innerHTML = "<p>No student accounts found.</p>";
        return;
      }

      studentUsers.forEach(email => {
        let div = document.createElement('div');
        div.className = 'account-item';
        div.innerText = email;
        studentAccountsList.appendChild(div);
      });
    }

    // ===========================
    // Initial Setup on Page Load
    // ===========================
    window.onload = function() {
      // Check if a user is already logged in (simple persistence)
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        const userData = JSON.parse(localStorage.getItem(`user_${savedUser}`));
        if (userData) {
          currentUser = savedUser;
          currentUserRole = userData.role;
          updateUIOnLogin();
        }
      }
      initializeEventListeners();
    }

    // ===========================
    // Handle Window Click to Close Modal
    // ===========================
    window.onclick = function(event) {
      if (event.target == authModal) {
        authModal.style.display = "none";
      }
    }
  </script>

</body>
</html>
